# 定制一个连续层级审批人规则

通过前面【新增审批人类型之模拟岗位审批功能完整实现指南】，跟着文档做你就可以完全定制一个全新的审批人规则。然而如你所见，完全新定制一个审批规则相当繁琐（但不复杂），强烈建议用户修改现有的审批规则来实现自己的业务需求（antflow提供了数十个内置审批人规则。其中可能并不是所有的用户都需要，用户可以修改一个自己不需要的来适配自己的业务。（比如hrbp审批，有的公司没有hrbp这样的角色。用户可以在前端把hrbp审批的名字改掉，后端查询hrbp的逻辑改为自己需要的审批人规则逻辑，即可快速实现自定义一个审批人规则。）


上面是对用户自定义审批人规则的建议，目的是为了让用户快速用户起来，少走弯路。本篇主要讲解的是如何快速定制一个连续多层级的审批人规则。之所以要单独来讲，是因为它和其它的审批人规则不同：其它的审批人规则都是针对某一个节点的，连续层级审批规则则是根据规则生成连续多个审批节点，依次审批。


## 前端

1.找到前端const.js文件，搜索【层层审批】找到以后，将注释放出来。

## 后端

1. 找到【BpmnLoopSignNodeAdp】类，它就是实现连续多级审批的类。
2. 将getAssigneeIds方法里面的所有内容全部删除掉
3. 重点关注queryLeadersByEmployeeIdAndTier方法。用户可以改写这个方法，返回自己期望的具有层级审批关第的人员列表。也可以完全去掉它，自己实现一个，AntFlow不关心你的方法名是什么，只需要返回List `<BaseIdTranStruVo>`即可。主方法需要的是一个List 进 ``<strting>`类型返回值。实际上是用户Id的集合。将List `<BaseIdTranStruVo>``进行管道转换即可得到符合预期的数据结构。


## 问题与解决方案

通过以上处理以后，自己返回了结果，但是流程发起时找不到人？

这是因为流程在其它环境需要根据Id信息查询用户名（甚至其它信息）用户还需要改写org.openoa.base.service.AfUserService#queryUserByIds方法，即根据传入的用户Id集合找到用户信息。

用户有两种办法来实现改写。第一，改写org.openoa.base.mapper.UserMapper#queryByIds，这是UserMapper里的一个方法，用户改写sql即可

第二，用户自己实现AfUserService接口。然后注册到spring bean容器里，并且标注为@primary,覆盖默认实现。（默认实现为UserServiceImpl，上面有较为详细的注释，哪些是必须实现的）

### 建议 AfUserService提供了大量的方法，用户可能一开始上来会比较懵逼。建议不要全面了解，只需要跟着文档实现指定的，其它的后面有需求再实现。


## 我还想实现其它的层级审批。


通过以上改造，用户就可以实现自定义一个层级审批规则。但是以上只有一个类，如果用户需要实现多个层级审批规则怎么办呢？

其实用户可以看到，默认的实现里面有一个loopEndType参数是灰色的，也就是没有使用。用户可以通过使用同一个主属性+多个扩展标签来实现自己的需求。

比如用户有两个层级审批规则。一个是员工的所有上级领导。 一个是用户所公司所有的财务领导。用户可以将loopEndType值为1当作员工上级领导，值为2当作财务领导。在程序代码中使用if来判断不同的业务，走不同的人员查询逻辑。

> 注意节点的主属性不能变，即NodeProperty值一定要是2，因为只有这样才能路由到这个策略里面。
